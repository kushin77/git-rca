name: Secrets Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    name: Scan for Hardcoded Secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: Install detection tools
        run: |
          pip install detect-secrets truffleHog
          
      - name: Run detect-secrets baseline scan
        id: detect-secrets
        run: |
          # Scan for high-entropy strings and known patterns
          detect-secrets scan --baseline .secrets.baseline \
            --exclude-files '\.git/,\.venv/,\.pytest_cache/,__pycache__/,logs/,node_modules/' \
            --exclude-lines 'test_.*=|mock.*=|dummy.*=|fake.*=|example.*=' \
            . || echo "SECRETS_FOUND=true" >> $GITHUB_ENV
          
      - name: Check for new secrets
        run: |
          # Compare against baseline to find NEW secrets only
          if [ -f .secrets.baseline ]; then
            detect-secrets audit .secrets.baseline
          fi
          
      - name: Run truffleHog for high-confidence findings
        continue-on-error: true
        run: |
          truffleHog filesystem . \
            --json \
            --only-verified \
            --entropy=False \
            --include-unverified=False \
            > truffleHog-results.json 2>&1 || true
          
          # Check if any verified secrets were found
          if grep -q '"verified".*true' truffleHog-results.json 2>/dev/null; then
            echo "‚ö†Ô∏è Verified secrets detected! Results saved to artifact"
            cat truffleHog-results.json
            exit 1
          fi
          
      - name: Run gitSecrets patterns
        run: |
          # Install git-secrets
          git clone https://github.com/awslabs/git-secrets.git /tmp/git-secrets
          cd /tmp/git-secrets
          make install
          cd -
          
          # Add AWS patterns
          git secrets --register-aws
          
          # Run secrets scan
          git secrets --scan || {
            echo "‚ùå Secrets scanning failed - hardcoded secrets detected"
            exit 1
          }
          
      - name: Run regex patterns for common secrets
        run: |
          python3 << 'PYTHON_EOF'
          import re
          import os
          import sys
          
          # Patterns for common secrets
          patterns = {
              'AWS_KEY': r'(?i)(aws_access_key_id|AKIA[0-9A-Z]{16})',
              'AWS_SECRET': r'(?i)(aws_secret_access_key|[A-Za-z0-9/+=]{40})',
              'PRIVATE_KEY': r'-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----',
              'API_KEY': r'(?i)(api[_-]?key|apikey|access[_-]?token|secret[_-]?key|password)\s*[:=]\s*[\'"]?[A-Za-z0-9\-_]{20,}',
              'JWT_TOKEN': r'eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+',
              'SLACK_TOKEN': r'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[A-Za-z0-9_-]{32}',
              'GITHUB_TOKEN': r'gh[pousr]_[A-Za-z0-9_]{36,255}',
              'STRIPE_KEY': r'sk_(live|test)_[0-9a-zA-Z]{20,}',
              'POSTGRES_URI': r'postgres(ql)?://[a-zA-Z0-9:@/.?#\[\]@!$&\'()*+,;=%_-]{20,}',
          }
          
          # Files to exclude
          exclude_dirs = {'.git', '.venv', '__pycache__', '.pytest_cache', 'logs', '.env.example', 'node_modules'}
          exclude_files = {'.secrets.baseline', '.gitignore', 'requirements.txt', 'package-lock.json'}
          
          found_secrets = False
          
          for root, dirs, files in os.walk('.'):
              # Remove excluded directories
              dirs[:] = [d for d in dirs if d not in exclude_dirs]
              
              for file in files:
                  # Skip excluded files
                  if file in exclude_files or file.endswith('.pyc'):
                      continue
                  
                  filepath = os.path.join(root, file)
                  
                  # Skip binary files and large files
                  if not os.path.isfile(filepath):
                      continue
                  if os.path.getsize(filepath) > 1000000:  # 1MB
                      continue
                  
                  try:
                      with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                          content = f.read()
                          
                          for pattern_name, pattern in patterns.items():
                              matches = re.finditer(pattern, content, re.MULTILINE | re.IGNORECASE)
                              for match in matches:
                                  # Skip test files and examples
                                  if 'test' in filepath.lower() or 'example' in filepath.lower():
                                      continue
                                  
                                  found_secrets = True
                                  line_no = content[:match.start()].count('\n') + 1
                                  print(f"‚ùå [{pattern_name}] found in {filepath}:{line_no}")
                                  print(f"   Context: {match.group()[:50]}...")
                  except Exception as e:
                      pass
          
          if found_secrets:
              sys.exit(1)
          else:
              print("‚úÖ No secrets detected by regex patterns")
          PYTHON_EOF
          
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: secrets-scan-results
          path: |
            .secrets.baseline
            truffleHog-results.json
          retention-days: 30
          
      - name: Report Summary
        if: always()
        run: |
          echo "## üîê Secrets Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Run:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ detect-secrets (high-entropy strings)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ truffleHog (verified secrets)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ git-secrets (AWS patterns + custom)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Regex patterns (API keys, tokens, URIs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Result:" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ No secrets detected" >> $GITHUB_STEP_SUMMARY
